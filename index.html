<!doctype html>
<html lang="en">

  <head>
    <meta charset="utf-8">

    <title>frontend-testing-redefined</title>

    <meta name="description" content="Presentation on frontend testing using the new tool Cypress held at FINN Academy 2017.05.24">
    <meta name="author" content="Stig Kleppe-Jørgensen">

    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">

    <link rel="stylesheet" href="css/reveal.css">
    <link rel="stylesheet" href="css/theme/simple.css" id="theme">

    <!-- Code syntax highlighting -->
    <link rel="stylesheet" href="css/highlight/styles/zenburn.css" id="highlight-theme">

    <!-- Printing and PDF exports -->
    <script>
      var link = document.createElement( 'link' );
      link.rel = 'stylesheet';
      link.type = 'text/css';
      link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
      document.getElementsByTagName( 'head' )[0].appendChild( link );
    </script>

    <!-- INCLUDE CSS HERE -->

  </head>

  <body>

    <div class="reveal">
      <div class="slides"><section id="chapter-intro" class="chapter">
<section id="intro-intro" class="slide" data-has-notes="true">
<h2>Frontend testing redefined</h2><h5>a.k.a. this week in &quot;up-and-coming bleeding edge &#39;oh god there&#39;s no turning back now we&#39;re in way over our heads&#39; unstable testing frontend framework&quot;</h5><h2>Cypress</h2><aside class="notes"><p>Vegard:
Hei, denne gamlingen heter Stig og jeg heter Vegard og vi jobber i FINN Reise.
Når Reise står på scenen betyr det en av to ting:
    Enten et nytt bleeding edge, ustbilt testrammeverk funnet via en eller annen random techblog
    Eller at Stig har funnet ut noe nytt han kan i docker; typ ringeklokka hjemme kanskje?</p>
<p>Som forhåpentligvis mange her har fått med seg, er vi i Reise veldig glade i tester.</p>
<p>Dvs vi er ikke så veldige glade i frontend-testene våre. Det er flere grunner til det.
Først og fremst fordi de er ustabile. I tillegg er de trege og vanskelige å skrive.</p>
<p>Nå har vi kommet over et nytt og spennende verktøy for frontend testing som heter Cypress
som vi tenkte vi skulle vise for dere.</p></aside>
</section>

<section id="intro-old-stuff" class="slide" data-has-notes="true">
<h2>Old stuff</h2><ul>
<li>Selenium/Webdriver<ul>
<li>PhantomJS</li>
<li>Chrome</li>
</ul>
</li>
<li>CodeceptJS<ul>
<li>Nightmare/Electron</li>
</ul>
</li>
</ul><aside class="notes"><p>Men først lurte jeg litt på hvem her som driver med eller har drevet med FE testing?
Selenium? Med phantomjs/ordentlig browser? Eller Electron via f.eks. Nightmare</p>
<p>I Reise så har vi brukt Selenium og PhantomJS lenge med mange problemer</p>
<ul>
<li>ustabilt/timeouts</li>
<li>browser ingen bruker</li>
<li>ikke noe videreutvikling</li>
</ul>
<p>Har så vidt prøvd oss på CodeceptJS som er en wrapper over Nightmare som styrer
Electron direkte. Det skal Vegard snakke mer om etterpå.</p>
<p>Bare å spørre underveis</p></aside>
</section>

<section id="intro-cypress" class="slide" data-has-notes="true">
<h2>Cypress</h2><ul>
<li>Download and run</li>
<li>Real browser (Chrome)<ul>
<li>Tests run inside browser</li>
<li>Use Chrome developer tools</li>
</ul>
</li>
<li>Simple async API<ul>
<li>No waits/sleeps needed</li>
</ul>
</li>
<li>Mock network calls inside browser</li>
</ul><aside class="notes"><p>Så over til Cypress</p>
<p>Her er det veldig enkelt å komme i gang; bare last ned og kjør
Ikke nødvendig å installere noe annet, ikke node, browser, selenium eller noe annet.</p>
<p>Testene blir kjørt inne i en ordentlig browser som gjør at testene blir mye mer
stabile. Bare Chrome pr nå, men planen er å få inn flere. Her har man også tilgang
til alle verktøyene man er vant til når man debugger, etc.</p>
<p>APIet som brukes for å styre browseren er async, basert på Promises, så en trenger
ikke legge inn waits selv</p>
<p>Sist men ikke minst kan man mocke ajax call i browseren, dvs. den setter opp noe
ala nock eller wiremock inne i browseren. Dette er også med på å gjøre testene mye
mer stabile og enklere å sette opp.</p></aside>
</section>

<section id="intro-demo" class="slide" data-has-notes="true">
<h2>Demo</h2><aside class="notes"><p>Så over til demoen.</p>
<p>Vi skal kjøre en end-2-end test av en liten todo app som helt sikkert mange
kjenner igjen. En liten forskjell her er at den gjør kall til et api som i
dette tilfellet er en Kotlin app.</p>
<p>&lt; kjør &gt;</p>
<p>Her kan vi se at kjøringen av testene vises til venstre i browseren, mens appen
vises i høyre del live mens den blir styrt av testen.</p>
<p>Dette er en vanlig Chrome instans som kjører i en egen profil. Cypress er mer
eller mindre &quot;bare&quot; en Chrome plugin.</p>
<p>Hva skjer nå hvis vi prøver å stoppe apiet</p>
<p>&lt; stopp apiet &gt;
&lt; kjør &gt;</p>
<p>Som forventet så feiler testene. Men hva med å mocke ut nettverkskall? La oss
prøve det.</p>
<p>Her ser dere at testene er skrevet i Mocha BDD style. Assertions er basert på
Chai. Spørringene gjøres med CSS selectors. APIet er promise-basert som gjør
det mulig for Cypress å f.eks. gjøre retries automatisk. Neste steg kjøres også
først når det aktive resolves, dvs. ingen sleeps er nødvendig</p>
<p>&lt; enable component, disable e2e &gt;
&lt; &#39;nomatch&#39; på assert contain + syntaks feil &gt;
&lt; kjør &gt;
&lt; feil vises på høyre side &gt;
&lt; fiks syntaks feil &gt;
&lt; kjør &gt;</p>
<p>Disse testene kjører uten api selv om de gjør kall. Her er hvordan dette settes opp
i testen. Man setter opp ruter og hvordan disse skal håndteres. I stedet for å
skrive test-data her kan man også referere filer.</p>
<p>Her kan man også vente på at nettverkskallet er gjort og så sjekke på at kallet
ser ut som man forventer. Venting på nettverkskall (og response) gjør igjen at
testene blir mer stabile.</p>
<p>Debugging av tester er veldig mye enklere i Cypress. Den tar snapshot av DOMen
for hvert steg slik at man kan gå fram og tilbake i loggen og se hvordan appen så
ut. For hvert steg kan en se før/etter tilstand (mus-klikk, etc).</p>
<p>Disse utmockede nettverkskallene blir også vist her. Enda mer info får en i
developer tools. Og en kan også kjøre apiet her --&gt; cy.viewport(iphone-6)</p>
<p>Og når man skal kjøre dette på CI eller bare sammen med en større test-suite, så
kan man kjøre vha en cli som også lager video og screenshots.</p>
<ul>
<li><p>reruns tests if files are changed</p>
</li>
<li><p>beta</p>
</li>
<li>only Chrome for now</li>
<li>ci uses Electron</li>
<li>not true headless (needs xvfb++)</li>
</ul>
<p>Gotchas</p>
<ul>
<li>window.fetch is not supported for network requests. Probably will use a fetch polyfill, so just set window.fetch = null</li>
</ul></aside>
</section>
</section>

<section id="chapter-experience" class="chapter">
<section id="experience-new-fhh" class="slide" data-has-notes="true">
<h3>New vacationhome solution (FHH)</h3><ul>
<li>Module testing for new FHH result site<ul>
<li>api written in java</li>
<li>web written in react</li>
</ul>
</li>
<li>Codecept with Nightmare.js (<a href="http://codecept.io/helpers/Nightmare/">http://codecept.io/helpers/Nightmare/</a>)<ul>
<li>nock for mocking (<a href="https://github.com/node-nock/nock">https://github.com/node-nock/nock</a>)</li>
</ul>
</li>
</ul><aside class="notes"><p>Ny feriehus, komme oss ut av mfinn
kun resultatsiden, håp om objektsiden
prøveprosjekt med søkeside som skulle ab-testes
apiet, eller &quot;backend&quot; kjører på spring boot
fhh-web, eller &quot;frontend&quot; kjører i node</p>
<p>Codecept wrapper nightmare</p></aside>
</section>

<section id="experience-codecept" class="slide" data-has-notes="true">
<h3>Codecept with Nightmare.js</h3><ul>
<li>Required 3rd party mocking framework<ul>
<li>Nock</li>
</ul>
</li>
<li>Helper methods makes syntax look clean</li>
<li>Custom helpers</li>
</ul>
<pre><code class="lang-javascript"><span class="hljs-comment">/* globals Helper */</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Browser</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Helper</span> </span>{
    mouseover (selector) {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.helpers.Nightmare
            .browser.mouseover(selector);
    }
    resizeWindow (width, height) {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.helpers.Nightmare
            .browser.viewport(width, height);
    }

}
<span class="hljs-built_in">module</span>.exports = Browser;
</code></pre><aside class="notes"><p>Som nevnt trenger codecept et eksternt bibliotek for mocking
Nock sender et kall mot &quot;fhh-api&quot;, som må mockes ut. 
    konsollen sier fra hvis et &quot;ulovlig&quot; kall blir gjort
        søkesiden gjorde kall mot api som ikke var planlagt
            fortsatt ikke fikset?
    nock.cleanAll() rydder opp i mocks, og brekker bygget hvis en mock har blitt satt opp, men ikke blitt brukt
        fin måte å se om koden oppfører seg som forventet
            her burde det skjedd et kall
Codecept har skrevet hjelpemetoder, vise eksempler senere
Kan skrive egne hjelpemetoder</p></aside>
</section>

<section id="experience-cypress" class="slide" data-has-notes="true">
<h3>Cypress</h3><ul>
<li>Cypress extends Mocha, using mocha syntax<ul>
<li>describe, it, beforeEach, only, skip etc</li>
</ul>
</li>
<li>Watch mode</li>
<li>Rich API, but no &quot;helper methods&quot;</li>
<li>Wonky with server side rendering</li>
</ul><aside class="notes"><p>Mocha gjør det mulig å gruppere tester
    1 av 10 tester ikke trenger beforeeach
        tungvint i codecept
should have.class klassenavn
watch mode gjør at det går mye fortere å gjøre endringer
    codecept må kjøre opp yarn test:module, kanskje sette pause() breakpoints for å debugge
ingen hjelpemetoder ala codecept, skriver de basically selv
fordi cypress ikke kjører med ssr, så får vi ikke responsen fra serveren
    bookingtester som ikke fungerer, broadcast, brokers fra prometheus (alle testene fungerte i codecept)</p></aside>
</section>

<section id="experience-comparison-test" class="slide" data-has-notes="true">
<h3>Test Code</h3><p>Codecept:</p>
<pre><code class="lang-javascript">Scenario(<span class="hljs-string">'Has object marker'</span>, (resultPage, fhhMap) =&gt; {
    fhhMap.mockSingleCabin();
    resultPage.goto();
    fhhMap.hasMapMarker();
});
</code></pre>
<p>Cypress</p>
<pre><code class="lang-javascript">it(<span class="hljs-string">'Has heatmap marker'</span>, () =&gt; {
    cy
        .hasComponentByClassName(<span class="hljs-string">'leaflet-marker-icon'</span>);
});
</code></pre><aside class="notes"><p>Fordi Cypress bruker Mocha, så ligger mesteparten av koden i beforEach.
En test kan derfor fokusere på hva den faktisk vil teste</p></aside>
</section>

<section id="experience-comparison-page" class="slide" data-has-notes="true">
<h3>Page Code</h3><p>Codecept:</p>
<pre><code class="lang-javascript">hasMapMarker () {
        I.seeElement(<span class="hljs-string">'.leaflet-marker-icon'</span>);
},
</code></pre>
<p>Cypress copy of codecept method:</p>
<pre><code class="lang-javascript">Cypress.addParentCommand(<span class="hljs-string">'hasMapMarker'</span>, () =&gt; {
        cy.get(<span class="hljs-string">'.leaflet-marker-icon'</span>);
});
</code></pre>
<p>Cypress:</p>
<pre><code class="lang-javascript">Cypress.addParentCommand(<span class="hljs-string">'hasComponentByClassName'</span>, 
    (className) =&gt; {
        cy.get(<span class="hljs-string">`.<span class="hljs-subst">${className}</span>`</span>);
    }
);
</code></pre><aside class="notes"><p>Codecept er lettere å lese, men dette er nightmare-wrapperen som de har skrevet, hjelpemetodene</p>
<p>Midterste metoden er en ren kopi hvis jeg skulle skrevet samme metode i cypress</p>
<p>Nederste er hvordan jeg valgte å implementere det.
Istedenfor å ha mange metoder som gjør det samme så valgte jeg generiske metoder med selector som input</p></aside>
</section>

<section id="experience-pros-cons" class="slide" data-has-notes="true">
<h3>Pros and cons</h3><p>Cypress:</p>
<ul>
<li>Pros<ul>
<li>Live updating $$$</li>
<li>Mocha &amp; Route/call counter</li>
<li>DOM snapshot of each step</li>
<li>Good documentation; decent examples<ul>
<li><code>(&quot;have.attr&quot;, &quot;src&quot;, &quot;image.png&quot;)</code></li>
<li><code>(&quot;have.attr&quot;, &quot;href&quot;, &quot;/users&quot;)</code></li>
</ul>
</li>
</ul>
</li>
<li>Cons<ul>
<li>SSR makes things difficult</li>
<li>Stackoverflow won&#39;t save your ass</li>
</ul>
</li>
</ul><aside class="notes"><p>Live oppdatering/watch mode er gull for kontinuerlig utvikling av tester. Øker produktiviteten enormt
Mocha er bra
Oversikt over hvilke ruter som har blitt kallt og hvor mange; pga navngiving er det veldig lett å se om det har skjedd et uventet kall
DOM snapshotting gjør at man kan gå over stegvis hva som skjer i testen. Veldig nyttig for å finne ut hva som feiler
    Codecept kan sette pause breakpoints i koden, men det må man manuelt skrive, og så kjøre opp testen på nytt
    hver gang man endrer plassering
Relativt god dokumentasjon, ok eksempler. Par situasjoner hvor det har vært litt tynt, men da har det ofte vært
en kombinasjon av at jeg ikke kjenner hjelpeverktøyene også (chai feks)
    (have.attr, &#39;src&#39;, &#39;image&#39;)
    vet ikke hvorfor. src er kanskje ikke gjenkjent som en attributt? er listet under det på MDN</p>
<p>Som nevnt tidligere, SSR gjør ting litt vanskelig. Testing av broadcast feks ble løst med if else
    if ssr enabled -&gt; produksjonskode, else -&gt; testkode
        broadcast synlig på alle tester
        kunne ikke teste om bookingsiden for en gitt bruker hadde satt opp bookings riktig
        fordi første kall ikke var mulig å mocke ut (kom fra serveren)</p>
<p>Nytt og uprøvd med de ulemper det påfører + liten hjelp å få på stackoverflow; github diskusjoner/feature requester, eksempelprosjekter</p></aside>
</section>
</section></div>
    </div>

    <script src="lib/js/head.min.js"></script>
    <script src="js/reveal.js"></script>

    <script>
    // Full list of configuration options available at:
    // https://github.com/hakimel/reveal.js#configuration
    Reveal.initialize({
      controls: true,
      progress: true,
      history: true,
      center: true,

      transition: Reveal.getQueryHash().transition || 'slide', // none/fade/slide/convex/concave/zoom

      // Optional reveal.js plugins
      dependencies: [
        //{ src: 'plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
        //{ src: 'plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
        //{ src: 'plugin/highlight/highlight.js', async: true, condition: function() { return !!document.querySelector( 'pre code' ); }, callback: function() { hljs.initHighlightingOnLoad(); } },
        { src: 'plugin/zoom-js/zoom.js', async: true },
        { src: 'plugin/notes/notes.js', async: true }
      ]
    });
    </script>

    <!-- INCLUDE JS HERE -->

  </body>
</html>
